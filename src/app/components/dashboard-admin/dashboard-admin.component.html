<div class="dashboard-container">
  <div class="card full-width">
    <div class="card-header dashboard-header">
      <h2>Admin Dashboard</h2>
      <div class="view-toggles">
        <button class="btn" [class.btn-primary]="currentView==='users'" 
                (click)="switchView('users')">Users</button>
        <button class="btn" [class.btn-primary]="currentView==='orders'" 
                (click)="switchView('orders')">Orders</button>
        <button class="btn" [class.btn-primary]="currentView==='centers'" 
                (click)="switchView('centers')">Maintenance Centers</button>
        <button class="btn" [class.btn-primary]="currentView==='profiles'" 
                (click)="switchView('profiles')">Profiles</button>
      </div>
    </div>

    <!-- Alerts -->
    <div *ngIf="successMessage" class="alert success fade-in">{{ successMessage }}</div>
    <div *ngIf="errorMessage" class="alert error fade-in">{{ errorMessage }}</div>

    <div class="card-body">
      <!-- Loading Indicator -->
      <div *ngIf="isLoading" class="loading-overlay">
        <div class="spinner"></div>
      </div>

      <!-- USERS -->
      <div *ngIf="currentView==='users'" class="fade-in">
        <h3>Users</h3>

        <!-- Filters -->
        <div class="filters">
          <input type="text" placeholder="Search by name or email" [(ngModel)]="searchTerm" />
          <select [(ngModel)]="roleFilter">
            <option value="">All Roles</option>
            <option value="admin">Admin</option>
            <option value="seller">Seller</option>
            <option value="maintenanceCenter">Maintenance Center</option>
            <option value="user">User</option>
          </select>
          <button class="btn" (click)="loadUsers()">Apply Filters</button>
        </div>

        <!-- Table -->
        <table class="table" *ngIf="users.length > 0">
          <thead>
            <tr>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let u of users">
              <td><input [(ngModel)]="u.firstName" /></td>
              <td><input [(ngModel)]="u.lastName" /></td>
              <td>{{u.email}}</td>
              <td><span class="role-tag">{{u.role}}</span></td>
              <td class="actions">
                <button class="btn save" (click)="updateUserName(u._id, u.firstName, u.lastName)">Save</button>
                <button class="btn delete" (click)="deleteUser(u._id)">Delete</button>
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="users.length === 0 && !isLoading" class="empty-state">
          No users found
        </div>
      </div>

      <!-- ORDERS -->
      <div *ngIf="currentView==='orders'" class="fade-in">
        <div class="orders-header">
          <h3>Orders</h3>
          <div class="order-filters">
            <select [(ngModel)]="orderStatusFilter" (change)="loadOrders()">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="paid">Paid</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <button class="btn" (click)="loadOrders()">Refresh</button>
          </div>
        </div>

        <table class="table" *ngIf="orders.length > 0">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Total</th>
              <th>Payment</th>
              <th>Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of orders">
              <td class="order-id">{{order._id | slice:0:8}}...</td>
              <td>
                <div *ngIf="order.userId">
                  <div>{{getUserDisplay(order.userId)}}</div>
                  <small *ngIf="getUserEmail(order.userId)" class="text-muted">
                    {{getUserEmail(order.userId)}}
                  </small>
                  <small *ngIf="!getUserEmail(order.userId)" class="text-muted">
                    ID: {{order.userId | slice:0:8}}...
                  </small>
                </div>
                <div *ngIf="!order.userId">Unknown User</div>
              </td>
              <td>{{getOrderItemsSummary(order)}}</td>
              <td>${{order.totalPrice}}</td>
              <td>
                <span class="payment-method">{{order.paymentMethod || 'cash'}}</span>
              </td>
              <td>{{formatDate(order.createdAt)}}</td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(order.status)">
                  {{getStatusText(order.status)}}
                </span>
              </td>
              <td class="order-actions">
                <!-- Only show status actions for pending orders -->
                <div class="status-actions" *ngIf="order.status === 'pending'">
                  <button class="btn btn-success btn-sm" 
                          (click)="updateOrderStatus(order._id, 'paid')">
                    Mark as Paid
                  </button>
                  <button class="btn btn-warning btn-sm" 
                          (click)="updateOrderStatus(order._id, 'cancelled')">
                    Cancel
                  </button>
                </div>
                
                <!-- For paid orders, admin can cancel to restore stock -->
                <div class="status-actions" *ngIf="order.status === 'paid'">
                  <button class="btn btn-warning btn-sm" 
                          (click)="updateOrderStatus(order._id, 'cancelled')">
                    Cancel & Restock
                  </button>
                </div>
                
                <!-- View and Delete actions -->
                <div class="other-actions">
                  <button class="btn btn-info btn-sm" 
                          [routerLink]="['/orders', order._id]"
                          title="View Order Details">
                    View
                  </button>
                  <button class="btn btn-danger btn-sm" 
                          (click)="deleteOrder(order._id)"
                          title="Delete Order">
                    Delete
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="orders.length === 0 && !isLoading" class="empty-state">
          No orders found
        </div>
      </div>

      <!-- MAINTENANCE CENTERS -->
      <div *ngIf="currentView==='centers'" class="fade-in">
        <h3>Maintenance Centers</h3>
        <table class="table" *ngIf="centers.length > 0">
          <thead>
            <tr>
              <th>Name</th>
              <th>Address</th>
              <th>Contact</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of centers">
              <td>{{c.name}}</td>
              <td>{{c.location}}</td>
              <td>
                <div *ngIf="c.contactPhone">{{c.contactPhone}}</div>
                <div *ngIf="c.contactEmail">{{c.contactEmail}}</div>
              </td>
              <td>
                <button class="btn btn-danger btn-sm" (click)="deleteCenter(c._id)">Delete</button>
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="centers.length === 0 && !isLoading" class="empty-state">
          No maintenance centers found
        </div>
      </div>

      <!-- PROFILES -->
      <div *ngIf="currentView==='profiles'" class="fade-in">
        <h3>Profiles</h3>
        <app-dashboard-user></app-dashboard-user>
      </div>
    </div>
  </div>
</div>