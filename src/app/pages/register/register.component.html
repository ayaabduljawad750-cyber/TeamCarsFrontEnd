<div class="register-page">

  <!-- ================= STEP 1: SELECT ROLE ================= -->
  <div class="register-card fade-in" *ngIf="currentStep === 1">
    <div class="header">
      <h2>{{ 'REGISTER.WELCOME' | translate }}</h2>
      <p>{{ 'REGISTER.SUBTITLE' | translate }}</p>
    </div>

    <div class="role-grid">
      <!-- User Role -->
      <div class="role-card" (click)="selectRole('user')">
        <div class="role-icon user-bg"><i class="fas fa-user"></i></div>
        <div class="role-info">
          <h3>{{ 'REGISTER.USER' | translate }}</h3>
          <p>{{ 'REGISTER.USER_DESC' | translate }}</p>
        </div>
      </div>

      <!-- Seller Role -->
      <div class="role-card" (click)="selectRole('seller')">
        <div class="role-icon seller-bg"><i class="fas fa-store"></i></div>
        <div class="role-info">
          <h3>{{ 'REGISTER.SELLER' | translate }}</h3>
          <p>{{ 'REGISTER.SELLER_DESC' | translate }}</p>
        </div>
      </div>

      <!-- Maintenance Center Role -->
      <div class="role-card" (click)="selectRole('maintenanceCenter')">
        <div class="role-icon maint-bg"><i class="fas fa-tools"></i></div>
        <div class="role-info">
          <h3>{{ 'REGISTER.MAINTENANCE' | translate }}</h3>
          <p>{{ 'REGISTER.MAINTENANCE_DESC' | translate }}</p>
        </div>
      </div>
    </div>

    <div class="form-footer">
      {{ 'REGISTER.ALREADY_ACCOUNT' | translate }} <a routerLink="/login">{{ 'REGISTER.SIGN_IN' | translate }}</a>
    </div>
  </div>


  <!-- ================= STEP 2: REGISTRATION FORM ================= -->
  <div class="register-card fade-in" *ngIf="currentStep === 2">

    <button class="back-link" (click)="goBackToRoles()">
      <i class="fas fa-arrow-left"></i> {{ 'REGISTER.CHANGE_ROLE' | translate }}
    </button>

    <div class="header">
      <h2>{{ 'REGISTER.CREATE_ACCOUNT' | translate: { role: (selectedRole | titlecase) } }}</h2>
      <p>{{ 'REGISTER.FILL_DETAILS' | translate }}</p>
    </div>

    <form [formGroup]="registerForm" (ngSubmit)="register()">

      <!-- ROW: First Name & Last Name -->
      <div class="row-group">

        <!-- First Name -->
        <div class="form-group half-width">
          <label>{{ 'REGISTER.FIRST_NAME' | translate }}</label>
          <div class="input-wrapper">
            <i class="fas fa-user input-icon"></i>
            <input type="text" formControlName="firstName" [placeholder]="'REGISTER.FIRST_NAME_PLACEHOLDER' | translate"
              [class.error-happen]="isFieldInvalid('firstName')">
          </div>

          <!-- ERROR LOGIC: PRIORITY BASED -->
          <div class="error-text" *ngIf="isFieldInvalid('firstName')">
            <span *ngIf="f['firstName'].hasError('required')">{{ 'REGISTER.REQUIRED' | translate }}</span>

            <span *ngIf="!f['firstName'].hasError('required') && f['firstName'].hasError('minlength')">
              {{ 'REGISTER.MIN_LENGTH_3' | translate }}
            </span>

            <span
              *ngIf="!f['firstName'].hasError('required') && !f['firstName'].hasError('minlength') && f['firstName'].hasError('pattern')">
              {{ 'REGISTER.CAPITAL_PATTERN' | translate }}
            </span>
          </div>
        </div>

        <!-- Last Name -->
        <div class="form-group half-width">
          <label>{{ 'REGISTER.LAST_NAME' | translate }}</label>
          <div class="input-wrapper">
            <i class="fas fa-user input-icon"></i>
            <input type="text" formControlName="lastName" [placeholder]="'REGISTER.FIRST_NAME_PLACEHOLDER' | translate"
              [class.error-happen]="isFieldInvalid('lastName')">
          </div>

          <!-- ERROR LOGIC: PRIORITY BASED -->
          <div class="error-text" *ngIf="isFieldInvalid('lastName')">
            <span *ngIf="f['lastName'].hasError('required')">{{ 'REGISTER.REQUIRED' | translate }}</span>

            <span *ngIf="!f['lastName'].hasError('required') && f['lastName'].hasError('minlength')">
              {{ 'REGISTER.MIN_LENGTH_3' | translate }}
            </span>

            <span
              *ngIf="!f['lastName'].hasError('required') && !f['lastName'].hasError('minlength') && f['lastName'].hasError('pattern')">
              {{ 'REGISTER.CAPITAL_PATTERN' | translate }}
            </span>
          </div>
        </div>
      </div>

      <!-- Email -->
      <div class="form-group">
        <label>{{ 'REGISTER.EMAIL_LABEL' | translate }}</label>
        <div class="input-wrapper">
          <i class="fas fa-envelope input-icon"></i>
          <input type="email" formControlName="email" [placeholder]="'REGISTER.EMAIL_PLACEHOLDER' | translate"
            [class.error-happen]="isFieldInvalid('email')">
        </div>
        <div class="error-text" *ngIf="isFieldInvalid('email')">
          <span *ngIf="f['email'].hasError('required')">{{ 'REGISTER.REQUIRED' | translate }}</span>
          <span *ngIf="!f['email'].hasError('required') && f['email'].hasError('email')">{{ 'REGISTER.EMAIL_INVALID' |
            translate }}</span>
        </div>
      </div>

      <!-- Password -->
      <div class="form-group">
        <label>{{ 'REGISTER.PASSWORD_LABEL' | translate }}</label>
        <div class="input-wrapper">
          <i class="fas fa-lock input-icon"></i>
          <input [type]="typePassword ? 'text' : 'password'" formControlName="password"
            [placeholder]="'REGISTER.PASSWORD_PLACEHOLDER' | translate"
            [class.error-happen]="isFieldInvalid('password')">
          <span class="toggle-eye" (click)="togglePassword()">
            <i class="fas" [ngClass]="typePassword ? 'fa-eye-slash' : 'fa-eye'"></i>
          </span>
        </div>

        <!-- ERROR LOGIC: PRIORITY BASED -->
        <div class="error-text" *ngIf="isFieldInvalid('password')">
          <span *ngIf="f['password'].hasError('required')">{{ 'REGISTER.REQUIRED' | translate }}</span>

          <span *ngIf="!f['password'].hasError('required') && f['password'].hasError('minlength')">
            {{ 'REGISTER.PASSWORD_MIN_LENGTH' | translate }}
          </span>

          <span
            *ngIf="!f['password'].hasError('required') && !f['password'].hasError('minlength') && f['password'].hasError('pattern')">
            {{ 'REGISTER.PASSWORD_PATTERN' | translate }}
          </span>
        </div>
      </div>

      <!-- Confirm Password -->
      <div class="form-group fade-in" *ngIf="f['password'].value">
        <label>{{ 'REGISTER.CONFIRM_PASSWORD' | translate }}</label>
        <div class="input-wrapper">
          <i class="fas fa-lock input-icon"></i>
          <input [type]="typeConfirm ? 'text' : 'password'" formControlName="confirmPassword"
            [placeholder]="'REGISTER.CONFIRM_PASSWORD_PLACEHOLDER' | translate"
            [class.error-happen]="(isFieldInvalid('confirmPassword') || registerForm.hasError('mismatch')) && f['confirmPassword'].touched">
          <span class="toggle-eye" (click)="toggleConfirmPassword()">
            <i class="fas" [ngClass]="typeConfirm ? 'fa-eye-slash' : 'fa-eye'"></i>
          </span>
        </div>
        <div class="error-text" *ngIf="f['confirmPassword'].touched">
          <span *ngIf="f['confirmPassword'].hasError('required')">{{ 'REGISTER.REQUIRED' | translate }}</span>
          <span *ngIf="!f['confirmPassword'].hasError('required') && registerForm.hasError('mismatch')">{{
            'REGISTER.CONFIRM_PASSWORD_MISMATCH' | translate }}</span>
        </div>
      </div>

      <!-- NEW: COMMERCIAL IMAGE INPUT (Only for Seller/Maintenance) -->
      <div class="form-group fade-in" *ngIf="isCommercialRole()">
        <label>{{ 'REGISTER.COMMERCIAL_IMAGE' | translate }}</label>

        <div class="file-upload-wrapper" [class.error-border]="commercialFileError">
          <input type="file" (change)="onFileSelected($event)" accept="image/*" class="file-input">
          <div class="file-custom-label">
            <i class="fas fa-cloud-upload-alt"></i>
            <span *ngIf="!commercialFile">{{ 'REGISTER.UPLOAD_IMAGE' | translate }}</span>
            <span *ngIf="commercialFile" class="file-name">{{ commercialFile.name }}</span>

          </div>
        </div>

        <p class="error-text" *ngIf="commercialFileError">{{ commercialFileError }}</p>
      </div>

      <!-- Submit Button -->
      <button type="submit" class="submit-btn" [disabled]="isLoading">
        {{ isLoading ? ('REGISTER.CREATING_ACCOUNT' | translate) : ('REGISTER.SIGN_UP' | translate) }}
      </button>

      <!-- Server Side Error Message -->
      <div class="server-error" *ngIf="errorMessage">
        <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
      </div>

    </form>

    <div class="form-footer">
      {{ 'REGISTER.ALREADY_ACCOUNT' | translate }}<a routerLink="/login">{{ 'REGISTER.SIGN_IN' | translate }}</a>
    </div>
  </div>
</div>
