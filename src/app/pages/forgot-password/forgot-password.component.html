<div class="fp-page">
  <div class="fp-card fade-in">
    
    <!-- Back Button -->
    <button class="back-link" (click)="goBackStep()">
      <i class="fas fa-arrow-left"></i> {{ currentStep === 1 ? 'Back to Login' : 'Back' }}
    </button>

    <!-- ================= STEP 1: ENTER EMAIL ================= -->
    <div *ngIf="currentStep === 1">
      <div class="header">
        <h2>Forgot Password?</h2>
        <p>Enter your email to receive a verification code.</p>
      </div>

      <form [formGroup]="emailForm" (ngSubmit)="sendCode()">
        <div class="form-group">
          <label>Email Address</label>
          <div class="input-wrapper">
            <i class="fas fa-envelope input-icon"></i>
            <input type="email" formControlName="email" placeholder="example@mail.com"
              [class.error-happen]="emailForm.get('email')?.invalid && emailForm.get('email')?.touched">
          </div>
          <div class="error-text" *ngIf="emailForm.get('email')?.touched && emailForm.get('email')?.invalid">
            Please enter a valid email.
          </div>
        </div>

        <button type="submit" class="submit-btn" [disabled]="emailForm.invalid || isLoading">
          {{ isLoading ? 'Sending...' : 'Send Code' }}
        </button>
      </form>
    </div>

    <!-- ================= STEP 2: ENTER CODE ================= -->
    <div *ngIf="currentStep === 2" class="fade-in">
      <div class="header">
        <h2>Verify Code</h2>
        <p>We sent a code to <strong>{{ savedEmail }}</strong></p>
      </div>

      <div class="alert-success" *ngIf="successMessage">{{ successMessage }}</div>

      <form [formGroup]="codeForm" (ngSubmit)="verifyCode()">
        <div class="form-group">
          <label>Verification Code</label>
          <div class="input-wrapper">
            <i class="fas fa-key input-icon"></i>
            <input type="text" formControlName="code" placeholder="Enter code (e.g. 123456)"
              [class.error-happen]="codeForm.get('code')?.invalid && codeForm.get('code')?.touched">
          </div>
          <div class="error-text" *ngIf="codeForm.get('code')?.touched && codeForm.get('code')?.invalid">
            Code is required.
          </div>
        </div>

        <button type="submit" class="submit-btn" [disabled]="codeForm.invalid || isLoading">
          {{ isLoading ? 'Verifying...' : 'Verify Code' }}
        </button>
        
        <div class="resend-box">
          Didn't receive it? <button type="button" class="link-btn" (click)="sendCode()">Resend</button>
        </div>
      </form>
    </div>

    <!-- ================= STEP 3: NEW PASSWORD ================= -->
    <div *ngIf="currentStep === 3" class="fade-in">
      <div class="header">
        <h2>Reset Password</h2>
        <p>Create a new strong password.</p>
      </div>

      <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
        
        <!-- New Password Field -->
        <div class="form-group">
          <label>New Password</label>
          <div class="input-wrapper">
            <i class="fas fa-lock input-icon"></i>
            <input [type]="typePassword ? 'text' : 'password'" formControlName="newPassword" placeholder="New password"
               [class.error-happen]="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
            <span class="toggle-eye" (click)="togglePassword()">
              <i class="fas" [ngClass]="typePassword ? 'fa-eye-slash' : 'fa-eye'"></i>
            </span>
          </div>

          <!-- PRIORITY ERROR MESSAGES -->
          <div class="error-text" *ngIf="passwordForm.get('newPassword')?.touched && passwordForm.get('newPassword')?.invalid">
             
             <!-- 1. Check Required First -->
             <span *ngIf="passwordForm.get('newPassword')?.hasError('required')">
               Password is required
             </span>

             <!-- 2. If present, use Custom Validator Error Object ('weakPassword') -->
             <ng-container *ngIf="!passwordForm.get('newPassword')?.hasError('required') && passwordForm.get('newPassword')?.errors?.['weakPassword'] as wp">
                
                <!-- Priority 1: Length -->
                <span *ngIf="!wp.isValidLength">
                  Must be at least 8 characters
                </span>

                <!-- Priority 2: Uppercase -->
                <span *ngIf="wp.isValidLength && !wp.hasUpper">
                  Must contain at least one Uppercase letter
                </span>

                <!-- Priority 3: Lowercase -->
                <span *ngIf="wp.isValidLength && wp.hasUpper && !wp.hasLower">
                  Must contain at least one Lowercase letter
                </span>

                <!-- Priority 4: Number -->
                <span *ngIf="wp.isValidLength && wp.hasUpper && wp.hasLower && !wp.hasNumber">
                  Must contain at least one Number
                </span>

                <!-- Priority 5: Special Char -->
                <span *ngIf="wp.isValidLength && wp.hasUpper && wp.hasLower && wp.hasNumber && !wp.hasSpecial">
                  Must contain at least one Special Character (!@#$)
                </span>

             </ng-container>
          </div>
        </div>

        <!-- Confirm Password Field -->
        <div class="form-group">
          <label>Confirm Password</label>
          <div class="input-wrapper">
            <i class="fas fa-lock input-icon"></i>
            <input [type]="typeConfirm ? 'text' : 'password'" formControlName="confirmPassword" placeholder="Confirm password"
               [class.error-happen]="(passwordForm.get('confirmPassword')?.invalid || passwordForm.hasError('mismatch')) && passwordForm.get('confirmPassword')?.touched">
            <span class="toggle-eye" (click)="toggleConfirm()">
              <i class="fas" [ngClass]="typeConfirm ? 'fa-eye-slash' : 'fa-eye'"></i>
            </span>
          </div>
          <div class="error-text" *ngIf="passwordForm.get('confirmPassword')?.touched">
             <span *ngIf="passwordForm.hasError('mismatch')">Passwords do not match</span>
             <span *ngIf="passwordForm.get('confirmPassword')?.hasError('required') && !passwordForm.hasError('mismatch')">Required</span>
          </div>
        </div>

        <button type="submit" class="submit-btn" [disabled]="passwordForm.invalid || isLoading">
          {{ isLoading ? 'Resetting...' : 'Reset Password' }}
        </button>
      </form>
    </div>

    <!-- GLOBAL SERVER ERROR -->
    <div class="server-error" *ngIf="errorMessage">
      <i class="fas fa-exclamation-circle"></i> {{ errorMessage }}
    </div>

  </div>
</div>